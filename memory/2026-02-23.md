# 2026-02-23 Project Discussion Log

## Discussion Notes
- Conducted full gap analysis of implementation against AD, Tech Lead, AKP.md requirements
- Identified two AI Usage Scenario Examples (Section 3.2) not reflected in actual code
- Chose to implement both scenarios in code (Option A) rather than just documenting them
- Filled all remaining gaps from the analysis

## Conclusions & Decisions
- ✅ Scenario 1 (Document Parsing): Added pdfplumber-based table detection + OpenAI structuring in `document_parser.py`
- ✅ Scenario 2 (Frontend Integration): Enhanced `rag_engine.py` with channel-aware prompt instructions + Telegram 4096-char truncation
- ✅ Created `AI-USAGE.md` (required deliverable per Section 3.2 + 3.3)
- ✅ Added 3 sample documents via `scripts/generate_sample_docs.py` (HR PDF, Legal DOCX, Finance PDF)
- ✅ Added document re-parse endpoint (`POST /api/documents/{id}/reparse`) + UI button
- ✅ Added admin reclassify endpoint (`PUT /api/analytics/queries/{id}/reclassify`) + UI form on Intent Config page
- ✅ Added average latency metric to Analytics dashboard
- ✅ Created test suite: 34 unit tests covering rag_engine formatting, analytics service, intent service, document parser

## Open Questions
(None)

---

## Discussion Notes (Session 2)
- Reviewed how message history is handled — current implementation was stateless (no prior context passed to LLM)
- Decided to add per-user conversation memory to improve multi-turn query quality
- Decided to persist the agent response in QueryLog so it can be replayed as history

## Conclusions & Decisions (Session 2)
- ✅ Added `agent_response` column to `QueryLog` model (persists LLM answer alongside user query)
- ✅ Added `conversation_history_limit` setting to `config.py` (default: 5, overridable via env var `CONVERSATION_HISTORY_LIMIT`)
- ✅ Orchestrator loads last N `QueryLog` rows filtered by `user_id` + `channel` before each query and builds `[{role, content}]` history pairs
- ✅ RAG engine accepts `conversation_history` and injects it between system prompt and current user message in the OpenAI call
- ✅ History is scoped by `user_id` + `channel`; anonymous requests (no `user_id`) receive no history — by design
- ✅ SQLite DB migrated live with `ALTER TABLE query_logs ADD COLUMN agent_response TEXT`

## Related Tasks
- backend/STATUS.md
- frontend/STATUS.md
- release/STATUS.md
